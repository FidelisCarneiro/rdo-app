<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>SKIC RDO</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#4D4F53"/>
  <style>
    :root{
      --skic-chumbo:#4D4F53; --skic-vermelho:#C8102E; --skic-prata:#BBBCBC;
      --skic-azul-egeu:#00617F; --skic-azul-ceu:#0086BF; --skic-cinza-escuro:#333F48; --skic-laranja:#FF6A13;
    }
    body{ font-family: ui-sans-serif, system-ui; background:#f6f7f9; color:#222; }
    .container{ max-width:1100px; margin:0 auto; padding:1rem; }
    .card{ background:#fff; border-radius:1rem; padding:1rem; box-shadow:0 8px 24px rgba(0,0,0,.07); }
    .btn{ background:var(--skic-azul-egeu); color:#fff; padding:.5rem .8rem; border-radius:.8rem; border:0; cursor:pointer;}
    .btn:hover{ filter:brightness(1.05); }
    .btn.secondary{ background:var(--skic-vermelho); }
    .btn.neutral{ background:var(--skic-chumbo); }
    .btn.danger{ background:#b91c1c; }
    .input, .select, input, select, textarea{ border:1px solid #e5e7eb; border-radius:.6rem; padding:.45rem .6rem; outline:none; width:100%; }
    .grid{ display:grid; gap:1rem; }
    .grid-2{ grid-template-columns: repeat(2, minmax(0,1fr)); }
    .grid-3{ grid-template-columns: repeat(3, minmax(0,1fr)); }
    .hidden{ display:none; }
    header{ background:linear-gradient(90deg, var(--skic-chumbo), var(--skic-azul-egeu)); color:#fff; padding:1rem 0; margin-bottom:1rem; }
    nav .btn{ background:var(--skic-azul-ceu); }
    .tag{ background:#eef2f7; padding:.2rem .5rem; border-radius:.6rem; font-size:.8rem; }
    .section-title{ font-weight:700; color:var(--skic-cinza-escuro); margin-top:1rem; }
    .muted{ color:#6b7280; }
    .table{ width:100%; border-collapse: collapse; }
    .table th, .table td { border-bottom:1px solid #e5e7eb; padding:.5rem; text-align:left; }
    .gallery{ display:grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap:.75rem; }
    .thumb{ background:#fff; border:1px solid #e5e7eb; border-radius:.6rem; overflow:hidden; display:flex; flex-direction:column; }
    .thumb img, .thumb video{ width:100%; height:120px; object-fit:cover; }
    .thumb .cap{ font-size:.8rem; padding:.4rem .5rem; display:flex; justify-content:space-between; gap:.5rem; }
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; align-items:center; justify-content:center; z-index:50; }
    .modal .content{ background:#fff; padding:1rem; border-radius:1rem; width:min(96vw,720px); }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script defer src="./config.js"></script>
  <script defer src="./db.js"></script>
  <script defer src="./app.js"></script>
</head>
<body>
  <header>
    <div class="container" style="display:flex; gap:1rem; align-items:center; justify-content:space-between;">
      <h1><span id="brandName">SKIC RDO</span></h1>
      <div>
        <span class="tag" id="userEmail"></span>
        <button id="logoutBtn" class="btn secondary">Sair</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Auth -->
    <section id="authArea" class="grid grid-2">
      <div class="card">
        <h2>Entrar</h2>
        <form id="loginForm" class="grid">
          <input id="login_email" class="input" placeholder="email">
          <input id="login_pass" type="password" class="input" placeholder="senha">
          <button class="btn">Login</button>
        </form>
      </div>
      <div class="card">
        <h2>Novo cadastro</h2>
        <form id="registerForm" class="grid">
          <input id="reg_name" class="input" placeholder="nome">
          <input id="reg_email" class="input" placeholder="email">
          <input id="reg_phone" class="input" placeholder="telefone">
          <input id="reg_pass" type="password" class="input" placeholder="senha">
          <button class="btn">Criar conta</button>
        </form>
      </div>
    </section>

    <!-- App -->
    <section id="appArea" class="hidden">
      <div class="card" style="display:flex; gap:1rem; align-items:center; justify-content:space-between;">
        <nav style="display:flex; gap:.5rem; flex-wrap:wrap;">
          <button id="newRdoBtn" class="btn">Novo RDO</button>
          <button id="listRdoBtn" class="btn">RDOs</button>
          <button id="mastersBtn" class="btn">Cadastros</button>
        </nav>
        <span class="muted">PWA • Offline primeiro</span>
      </div>

      <!-- Lista RDO -->
      <section id="page-list-rdo" class="page">
        <h2 class="section-title">RDOs recentes</h2>
        <div id="rdoList" class="mt-2"></div>
      </section>

      <!-- Novo/Editar RDO -->
      <section id="page-new-rdo" class="page hidden">
        <h2 class="section-title">Novo / Editar RDO</h2>
        <form id="rdoForm" class="grid">
          <input id="rdo_id" type="hidden">
          <div class="grid grid-3">
            <div>
              <label>Obra</label>
              <select id="work_id" class="select"></select>
            </div>
            <div>
              <label>Nº RDO</label>
              <input id="rdo_number" type="number" class="input" placeholder="ex.: 1234">
            </div>
            <div>
              <label>Data</label>
              <input id="rdo_date" type="date" class="input">
            </div>
          </div>
          <div class="grid grid-3">
            <div>
              <label>Dia da semana</label>
              <input id="weekday" class="input" placeholder="ex.: Segunda">
            </div>
            <div class="muted" style="display:flex; align-items:flex-end;">
              <button type="button" id="prefillLastBtn" class="btn neutral">Usar último RDO</button>
            </div>
          </div>

          <div class="grid grid-3">
            <div>
              <label>Clima (manhã)</label>
              <input id="weather_morning" class="input" placeholder='{"temp_avg":...,"rain_sum":...}'>
            </div>
            <div>
              <label>Clima (tarde)</label>
              <input id="weather_afternoon" class="input" placeholder='{"temp_avg":...,"rain_sum":...}'>
            </div>
            <div>
              <label>Clima (noite)</label>
              <input id="weather_night" class="input" placeholder='{"temp_avg":...,"rain_sum":...}'>
            </div>
          </div>
          <div>
            <button type="button" id="fetchWeatherBtn" class="btn">Buscar clima automático</button>
            <span class="muted">Requer latitude/longitude na Obra (Open-Meteo).</span>
          </div>

          <h3 class="section-title">Efetivo</h3>
          <div class="grid grid-3">
            <div><label>Efetivo diurno</label><input id="day_eff" type="number" class="input" value="0"></div>
            <div><label>Efetivo noturno</label><input id="night_eff" type="number" class="input" value="0"></div>
          </div>

          <h3 class="section-title">Prazos</h3>
          <div class="grid grid-3">
            <div><label>Prazo Contratual (dias)</label><input id="prazo_contratual" type="number" class="input"></div>
            <div><label>Dias Decorridos</label><input id="dias_decorridos" type="number" class="input"></div>
            <div><label>Prorrogação (dias)</label><input id="prorrogacao" type="number" class="input" value="0"></div>
            <div><label>Dias Restantes</label><input id="dias_restantes" type="number" class="input"></div>
          </div>

          <h3 class="section-title">Colaboradores / Horas</h3>
          <div class="grid">
            <div class="grid grid-3">
              <select id="collabSel" class="select"></select>
              <button type="button" id="addCollabEntry" class="btn">Adicionar colaborador</button>
            </div>
            <table id="collabTable" class="table">
              <thead>
                <tr>
                  <th>Colaborador</th><th>Equipe</th><th>Atividade</th><th>Horas</th><th>Turno</th>
                  <th>Status</th><th>Obs.</th><th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <h3 class="section-title">Equipamentos</h3>
          <div class="grid">
            <div class="grid grid-3">
              <select id="equipSel" class="select"></select>
              <button type="button" id="addEquipEntry" class="btn">Adicionar equipamento</button>
            </div>
            <table id="equipTable" class="table">
              <thead>
                <tr>
                  <th>Equipamento</th><th>Medidor inicial</th><th>Medidor final</th><th>Horas</th><th>Operador</th><th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <h3 class="section-title">Ocorrências</h3>
          <div class="grid">
            <div><button type="button" id="addOccEntry" class="btn">Adicionar ocorrência</button></div>
            <table id="occTable" class="table">
              <thead>
                <tr>
                  <th>Categoria</th><th>Descrição</th><th>Atividade</th><th>Equipe</th><th>Horas perdidas</th><th>Início</th><th>Fim</th><th>Sev.</th><th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <h3 class="section-title">Anexos (fotos/vídeos)</h3>
          <div class="grid">
            <div style="display:flex; gap:.5rem; align-items:center; flex-wrap:wrap;">
              <input id="fileInput" type="file" class="input" multiple accept="image/*,video/*" style="max-width:420px;">
              <button type="button" class="btn" id="uploadBtn">Upload</button>
              <span class="muted">Salvos no bucket <code>attachments</code></span>
            </div>
            <div id="gallery" class="gallery"></div>
          </div>

          <h3 class="section-title">Assinaturas</h3>
          <div class="grid grid-2">
            <div class="card">
              <strong>Responsável pela obra</strong>
              <div style="display:flex; gap:.5rem; align-items:center; margin-top:.5rem;">
                <button type="button" class="btn" onclick="openSignModal('responsavel')">Assinar</button>
                <img id="sign_responsavel_preview" style="max-width:220px; max-height:80px; border:1px solid #e5e7eb; border-radius:.5rem;" />
              </div>
            </div>
            <div class="card">
              <strong>Cliente / Fiscal</strong>
              <div style="display:flex; gap:.5rem; align-items:center; margin-top:.5rem;">
                <button type="button" class="btn" onclick="openSignModal('cliente')">Assinar</button>
                <img id="sign_cliente_preview" style="max-width:220px; max-height:80px; border:1px solid #e5e7eb; border-radius:.5rem;" />
              </div>
            </div>
          </div>

          <div class="modal" id="signModal">
            <div class="content">
              <h3 id="signTitle">Assinatura</h3>
              <canvas id="signCanvas" width="650" height="200" style="border:1px solid #e5e7eb; border-radius:.6rem; width:100%;"></canvas>
              <div style="display:flex; gap:.5rem; margin-top:.5rem;">
                <button class="btn" onclick="saveSignature()">Salvar</button>
                <button class="btn neutral" onclick="clearSignature()">Limpar</button>
                <button class="btn secondary" onclick="closeSignModal()">Fechar</button>
              </div>
            </div>
          </div>

          <div style="display:flex; gap:.5rem;">
            <button class="btn">Salvar</button>
            <button type="button" id="genPdfBtn" class="btn secondary">Gerar PDF</button>
          </div>
        </form>
      </section>

      <!-- Cadastros -->
      <section id="page-masters" class="page hidden">
        <div class="grid grid-2">
          <div class="card">
            <h3>Obras</h3>
            <p class="muted">Inclua latitude/longitude para clima automático.</p>
            <form id="formWork" class="grid">
              <input id="work_name" class="input" placeholder="Nome da obra">
              <input id="work_manager" class="input" placeholder="Gestor">
              <input id="work_scope" class="input" placeholder="Escopo">
              <input id="work_contract" class="input" placeholder="Número do contrato">
              <input id="work_start" type="date" class="input">
              <input id="work_sign" type="date" class="input">
              <input id="work_end" type="date" class="input" placeholder="Previsão de conclusão">
              <input id="work_value" type="number" step="0.01" class="input" placeholder="Valor">
              <input id="work_resp" class="input" placeholder="Responsável técnico">
              <input id="work_art" class="input" placeholder="ART">
              <input id="work_lat" type="number" step="0.000001" class="input" placeholder="Latitude">
              <input id="work_lon" type="number" step="0.000001" class="input" placeholder="Longitude">
              <button type="button" class="btn" onclick="createWork()">Salvar Obra</button>
            </form>
          </div>
          <div class="card">
            <h3>Outros cadastros</h3>
            <div class="grid grid-2">
              <button class="btn" onclick="quickCreate('contractors')">+ Contratada</button>
              <button class="btn" onclick="quickCreate('activities')">+ Atividade</button>
              <button class="btn" onclick="quickCreate('collaborators')">+ Colaborador</button>
              <button class="btn" onclick="quickCreate('teams')">+ Equipe</button>
              <button class="btn" onclick="quickCreate('equipment')">+ Equipamento</button>
            </div>
          </div>
        </div>
      </section>
    </section>
  </main>

  <script>
    async function createWork(){
      const payload = {
        name: document.getElementById('work_name').value,
        manager: document.getElementById('work_manager').value,
        scope: document.getElementById('work_scope').value,
        contract_number: document.getElementById('work_contract').value,
        start_date: document.getElementById('work_start').value || null,
        signature_date: document.getElementById('work_sign').value || null,
        planned_end_date: document.getElementById('work_end').value || null,
        value: parseFloat(document.getElementById('work_value').value || "0"),
        responsible: document.getElementById('work_resp').value,
        art_number: document.getElementById('work_art').value,
        latitude: parseFloat(document.getElementById('work_lat').value || "0"),
        longitude: parseFloat(document.getElementById('work_lon').value || "0"),
      };
      const { error } = await supabaseClient.from('works').insert([payload]);
      if (error) return alert("Erro: " + error.message);
      alert("Obra criada.");
      await loadMasterData();
    }
    async function quickCreate(table){
      const name = prompt("Nome:");
      if (!name) return;
      let payload = { name };
      if (table === "contractors"){
        payload.cnpj = prompt("CNPJ (opcional):") || null;
        payload.phone = prompt("Telefone (opcional):") || null;
      }
      if (table === "equipment"){
        payload.brand = prompt("Marca:") || null;
        payload.model = prompt("Modelo:") || null;
        payload.meter_type = "horimeter";
      }
      const { error } = await supabaseClient.from(table).insert([payload]);
      if (error) return alert("Erro: " + error.message);
      alert("Registro criado.");
      await loadMasterData();
    }
  </script>
</body>
</html>
