<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>RDO</title>
  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#00617F"/>
  <style>
    :root{
      --bg:#f6f7f9; --fg:#1f2937; --muted:#6b7280;
      --brand:#00617F; --brand-2:#0086BF; --danger:#C8102E; --neutral:#4B5563; --card:#fff;
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial,sans-serif;background:var(--bg);color:var(--fg);}
    header{position:sticky;top:0;z-index:20;background:linear-gradient(180deg, #063543, #073c4c);color:#fff}
    .container{max-width:1100px;margin:0 auto;padding:1rem}
    .row{display:flex;gap:.75rem;align-items:center;justify-content:space-between}
    .brand{font-weight:800;letter-spacing:.5px}
    .nav{display:flex;gap:.5rem;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:12px;padding:.55rem .8rem;background:var(--brand);color:#fff;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
    .btn.secondary{background:var(--danger)}
    .btn.neutral{background:var(--neutral)}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.25);color:#fff}
    a.btn{text-decoration:none}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    main{padding:1rem}
    .card{background:var(--card);border-radius:var(--radius);padding:1rem;box-shadow:0 8px 24px rgba(0,0,0,.07);margin-bottom:1rem}
    .grid{display:grid;gap:1rem}
    .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .field input,.field select,.field textarea,input,select,textarea{width:100%;border:1px solid #e5e7eb;border-radius:12px;padding:.6rem .7rem}
    .muted{color:var(--muted)}
    .hidden{display:none !important}
    .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch;border-radius:12px;border:1px solid #e5e7eb}
    table{width:100%;border-collapse:collapse;min-width:720px}
    th,td{border-bottom:1px solid #e5e7eb;padding:.6rem;text-align:left;background:#fff}
    th{background:#fafafa}
    .gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:.75rem}
    .thumb{border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;background:#fff}
    .thumb img,.thumb video{width:100%;height:120px;object-fit:cover}
    .thumb .cap{font-size:.8rem;padding:.4rem .5rem;display:flex;justify-content:space-between;gap:.5rem;align-items:center}
    @media (max-width: 920px){ .grid-3{grid-template-columns:repeat(2,minmax(0,1fr))} }
    @media (max-width: 640px){
      .container{padding:.75rem}
      .grid-2,.grid-3{grid-template-columns:1fr}
      header .nav{display:none}
      header .row{flex-wrap:wrap}
      #mobileNavBtn{display:inline-flex}
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script defer src="./config.js"></script>
  <script defer src="./db.js"></script>
  <script defer src="./app.js"></script>
</head>
<body>
<header>
  <div class="container">
    <div class="row">
      <div class="brand">RDO</div>
      <nav class="nav" id="mainNav">
        <a href="#/rdos" id="navRdos" class="btn ghost">RDOs</a>
        <a href="#/rdo/new" id="navNew" class="btn ghost">Novo RDO</a>
        <a href="#/cadastros" id="navMasters" class="btn ghost">Cadastros</a>
      </nav>
      <div class="row" style="gap:.5rem">
        <button id="mobileNavBtn" class="btn ghost" style="display:none">Menu</button>
        <span class="muted" id="userEmail"></span>
        <button id="logoutBtn" class="btn secondary">Sair</button>
      </div>
    </div>
    <div id="mobileNav" class="hidden" style="margin-top:.5rem">
      <div class="row" style="gap:.5rem;flex-wrap:wrap">
        <a href="#/rdos" class="btn">RDOs</a>
        <a href="#/rdo/new" class="btn">Novo RDO</a>
        <a href="#/cadastros" class="btn">Cadastros</a>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <section id="authArea" class="grid grid-2">
    <div class="card">
      <h2>Entrar</h2>
      <form id="loginForm" class="grid">
        <input id="login_email" placeholder="email" autocomplete="username">
        <input id="login_pass" type="password" placeholder="senha" autocomplete="current-password">
        <button class="btn">Login</button>
      </form>
    </div>
    <div class="card">
      <h2>Novo cadastro</h2>
      <form id="registerForm" class="grid">
        <input id="reg_name" placeholder="nome">
        <input id="reg_email" placeholder="email">
        <input id="reg_phone" placeholder="telefone">
        <input id="reg_pass" type="password" placeholder="senha">
        <button class="btn">Criar conta</button>
      </form>
    </div>
  </section>

  <section id="appArea" class="hidden">
    <section id="page-list-rdo" class="page">
      <div class="card">
        <h2>RDOs</h2>
        <div id="rdoList"></div>
        <div id="rdoPagination" class="row" style="justify-content:flex-start"></div>
      </div>
    </section>

    <section id="page-new-rdo" class="page hidden">
      <div class="card">
        <h2>Novo / Editar RDO</h2>
        <form id="rdoForm" class="grid">
          <input id="rdo_id" type="hidden">
          <div class="grid grid-3">
            <div class="field"><label>Obra</label><select id="work_id"></select></div>
            <div class="field"><label>Nº RDO</label><input id="rdo_number" type="number"></div>
            <div class="field"><label>Data</label><input id="rdo_date" type="date"></div>
          </div>
          <div class="grid grid-3">
            <div class="field"><label>Dia da semana</label><input id="weekday"></div>
            <div class="field" style="display:flex;align-items:flex-end"><button type="button" id="prefillLastBtn" class="btn neutral">Usar último RDO</button></div>
          </div>
          <div class="grid grid-3">
            <div class="field"><label>Clima (manhã)</label><input id="weather_morning"></div>
            <div class="field"><label>Clima (tarde)</label><input id="weather_afternoon"></div>
            <div class="field"><label>Clima (noite)</label><input id="weather_night"></div>
          </div>
          <button type="button" id="fetchWeatherBtn" class="btn">Buscar clima automático</button>

          <h3>Efetivo e Prazos</h3>
          <div class="grid grid-3">
            <div class="field"><label>Efetivo diurno</label><input id="day_eff" type="number" value="0"></div>
            <div class="field"><label>Efetivo noturno</label><input id="night_eff" type="number" value="0"></div>
            <div class="field"><label>Prazo Contratual</label><input id="prazo_contratual" type="number"></div>
            <div class="field"><label>Dias Decorridos</label><input id="dias_decorridos" type="number"></div>
            <div class="field"><label>Prorrogação</label><input id="prorrogacao" type="number" value="0"></div>
            <div class="field"><label>Dias Restantes</label><input id="dias_restantes" type="number"></div>
          </div>

          <h3>Colaboradores / Horas</h3>
          <div class="grid">
            <div class="row" style="flex-wrap:wrap">
              <select id="collabSel"></select>
              <button type="button" id="addCollabEntry" class="btn">Adicionar colaborador</button>
              <button type="button" id="nfcBtn" class="btn neutral">Ler crachá (NFC)</button>
              <span class="muted" id="nfcHint">Android + Chrome, conexão HTTPS</span>
            </div>
            <div class="table-wrap">
              <table id="collabTable">
                <thead><tr><th>Colaborador</th><th>Equipe</th><th>Atividade</th><th>Horas</th><th>Turno</th><th>Status</th><th>Obs.</th><th></th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <h3>Equipamentos</h3>
          <div class="grid">
            <div class="row" style="flex-wrap:wrap">
              <select id="equipSel"></select>
              <button type="button" id="addEquipEntry" class="btn">Adicionar equipamento</button>
            </div>
            <div class="table-wrap">
              <table id="equipTable">
                <thead><tr><th>Equipamento</th><th>Medidor inicial</th><th>Medidor final</th><th>Horas</th><th>Operador</th><th></th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <h3>Ocorrências</h3>
          <div class="grid">
            <button type="button" id="addOccEntry" class="btn">Adicionar ocorrência</button>
            <div class="table-wrap">
              <table id="occTable">
                <thead><tr><th>Categoria</th><th>Descrição</th><th>Atividade</th><th>Equipe</th><th>Horas perdidas</th><th>Início</th><th>Fim</th><th>Sev.</th><th></th></tr></thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <h3>Anexos</h3>
          <div class="grid">
            <div class="row" style="flex-wrap:wrap"><input id="fileInput" type="file" multiple accept="image/*,video/*"><button type="button" id="uploadBtn" class="btn">Upload</button></div>
            <div id="gallery" class="gallery"></div>
          </div>

          <h3>Assinaturas</h3>
          <div class="grid grid-2">
            <div class="card"><strong>Responsável</strong> <div class="row"><button type="button" class="btn" onclick="openSignModal('responsavel')">Assinar</button><img id="sign_responsavel_preview" style="max-width:220px;max-height:80px"></div></div>
            <div class="card"><strong>Cliente/Fiscal</strong> <div class="row"><button type="button" class="btn" onclick="openSignModal('cliente')">Assinar</button><img id="sign_cliente_preview" style="max-width:220px;max-height:80px"></div></div>
          </div>

          <div class="row" style="flex-wrap:wrap"><button class="btn">Salvar</button><button type="button" id="genPdfBtn" class="btn secondary">Gerar PDF</button></div>
        </form>
      </div>
    </section>

    <section id="page-masters" class="page hidden">
      <div class="card">
        <h2>Cadastros</h2>
        <div class="row" style="flex-wrap:wrap">
          <a class="btn" href="#/cadastros/obras">Obras</a>
          <a class="btn" href="#/cadastros/contratadas">Contratadas</a>
          <a class="btn" href="#/cadastros/atividades">Atividades</a>
          <a class="btn" href="#/cadastros/colaboradores">Colaboradores</a>
          <a class="btn" href="#/cadastros/equipes">Equipes</a>
          <a class="btn" href="#/cadastros/equipamentos">Equipamentos</a>
        </div>
      </div>
      <div id="cad-viewport"></div>
    </section>
  </section>
</main>

<div class="hidden" id="signModal" style="position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:50">
  <div class="card" style="width:min(96vw,720px)">
    <h3 id="signTitle">Assinatura</h3>
    <canvas id="signCanvas" width="650" height="200" style="border:1px solid #e5e7eb;border-radius:12px;width:100%"></canvas>
    <div class="row"><button class="btn" onclick="saveSignature()">Salvar</button><button class="btn neutral" onclick="clearSignature()">Limpar</button><button class="btn secondary" onclick="closeSignModal()">Fechar</button></div>
  </div>
</div>

</body>
</html>
